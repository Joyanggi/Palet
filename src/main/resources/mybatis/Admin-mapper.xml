<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="Admin">
  
  	<!-- DashBoard -->
  
  	<select id="getWeekSales" resultType="Trillion.Palet.DTO.SalesDTO">
		select sum(totalprice)as salessum , payday as salesdate from (
		select totalprice, to_char(pay_time, 'YY/MM/DD')as payday from payment 
		UNION ALL
		select et_cost as totalprice, to_char(et_buydate, 'YY/MM/DD') as payday from exticket
		UNION ALL
		select pro_cost as totalprice, to_char(pro_buydate, 'YY/MM/DD') as payday from proticket
		) where payday >= to_char(sysdate-6, 'YY/MM/DD') group by payday order by payday desc
  	</select>
  	
  	<select id="getWeekCount" resultType="Trillion.Palet.DTO.SalesDTO">
  		select sum(salescount)as salescount , payday as salesdate from (
		select g_count as salescount, to_char(pay_time, 'YY/MM/DD')as payday from payment 
		UNION ALL
		select et_count as salescount, to_char(et_buydate, 'YY/MM/DD') as payday from exticket
		UNION ALL
		select pro_count as salescount, to_char(pro_buydate, 'YY/MM/DD') as payday from proticket
		) where payday >= to_char(sysdate-6, 'YY/MM/DD') group by payday order by payday desc
  	</select>
  	
  	<!-- Member -->
  	
  	<update id="adminMemberModi">
		update member set name = #{name}, grade= #{grade}, point = #{point} where email = #{email}  	
  	</update>
  	
  	<delete id="adminMemberBan">
  		delete from member where email = #{value}
  	</delete>
  	
  	<update id="adminMemberUpdate">
  		update member set grade = #{grade} where email = #{email}
  	</update>
  	
  	<select id="getMemberPayment" resultType='Trillion.Palet.DTO.AdminDTO'>
  		select * from (
		select merchant_uid, g_name as title, totalprice as price, pay_time, category from payment where email = #{value}
		UNION ALL
		select et_booknumber as merchant_uid, et_title as title, et_cost as price, et_buydate as pay_time, et_category as category from exticket where et_email = #{value}
		UNION ALL
		select pro_booknumber as merchant_uid, pro_title as title, pro_cost as price, pro_buydate as pay_time, pro_category as category from proticket where pro_email = #{value}) where pay_time > sysdate-13 order by pay_time desc
  	</select>
  	
  	<!-- Exhibition -->
  	
  	<update id="adminExhibitionUpdate">
  		update exhibition set e_name = #{e_name}, start_date = #{start_date}, end_date = #{end_date}, e_price = #{e_price} 
  		where e_num = #{e_num}
  	</update>
  	
  	<!-- Goods -->
  	
  	<update id="adminGoodsUpdate">
  		update goods set g_name = #{g_name}, g_stock = #{g_stock}, g_price = #{g_price} where g_num = #{g_num}
  	</update>
  	
  	<!-- Payment -->
  	
  	<select id="paymentSelectByPage" resultType="Trillion.Palet.DTO.TotalPaymentDTO">
  		with total1 as (
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket),
		total2 as(
		select row_number() over(order by pay_time desc) line, merchant_uid, name, email, phone, totalprice, pay_time, state, category
		from total1)
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from total2 where line between #{start} and #{end}
  	</select>
  	
  	<select id="getPaymentTotalCount" resultType="int">
  		select count(*)
		from (select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket)
  	</select>
  	  	
  	<select id="paymentSelectUIDByPage" resultType="Trillion.Palet.DTO.TotalPaymentDTO">
  		with total1 as (
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment where merchant_uid like '%'||#{uid}||'%'
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket where et_booknumber like '%'||#{uid}||'%'
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket where pro_booknumber like '%'||#{uid}||'%'),
		total2 as(
		select row_number() over(order by pay_time desc) line, merchant_uid, name, email, phone, totalprice, pay_time, state, category
		from total1)
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from total2 where line between #{start} and #{end}
  	</select>
  	
  	<select id="getPaymentUIDTotalCount" resultType="int">
  		select count(*)
		from (select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket) where merchant_uid like '%'||#{search}||'%'
  	</select>
  	
  	<select id="paymentSelectNameByPage" resultType="Trillion.Palet.DTO.TotalPaymentDTO">
  		with total1 as (
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment where name like '%'||#{name}||'%'
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket where et_username like '%'||#{name}||'%'
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket where pro_username like '%'||#{name}||'%'),
		total2 as(
		select row_number() over(order by pay_time desc) line, merchant_uid, name, email, phone, totalprice, pay_time, state, category
		from total1)
		select merchant_uid, name, email, phone, totalprice, pay_time, state, category from total2 where line between #{start} and #{end}
  	</select>
  	
  	<select id="getPaymentNameTotalCount" resultType="int">
  		select count(*)
		from (select merchant_uid, name, email, phone, totalprice, pay_time, state, category from payment
		UNION ALL
		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone, 
		et_cost as totalprice, et_buydate as pay_time, et_state as state, et_category as category from exticket
		UNION ALL
        select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
        pro_cost as totalprice, pro_buydate as pay_time, pro_state as state, pro_category as category from proticket) where name like '%'||#{search}||'%'
  	</select>
  	
  	<select id="getAdminPayDetail" resultType="Trillion.Palet.DTO.AdminDTO">
  		select merchant_uid, name, email, phone, address1, address2, zipcode, g_name as title,
  		 card_name, card_number, card_quota, state, category, totalprice as price, pay_time, delivery_text, 
  		 g_option as options, g_count as count, point, usedpoint, cpdiscount, cpserial from payment 
  		 where merchant_uid = #{value}
  	</select>
  	
  	<select id="getAdminExticketDetail" resultType="Trillion.Palet.DTO.AdminDTO">
  		select et_booknumber as merchant_uid, et_username as name, et_email as email, et_phone as phone,
		et_title as title, et_place as place, et_paymethod as card_name, et_date as period, et_state as state,
		et_category as category, et_cost as price, et_buydate as pay_time, et_count as count, et_point as point,
		et_usedpoint as usedpoint, et_cpdiscount as cpdiscount, et_cpserial as cpserial from exticket where et_booknumber = #{value}
	</select>
	
	<select id="getAdminProticketDetail" resultType="Trillion.Palet.DTO.AdminDTO">
		select pro_booknumber as merchant_uid, pro_username as name, pro_email as email, pro_phone as phone,
		pro_title as title, pro_place as place, pro_paymethod as card_name, pro_date as period, pro_state as state,
		pro_category as category, pro_cost as price, pro_buydate as pay_time, pro_count as count, pro_point as point,
		pro_usedpoint as usedpoint, pro_cpdiscount as cpdiscount, pro_cpserial as cpserial from proticket where pro_booknumber = #{value}
	</select>
  	
  	<select id="cancelSelectByPage" resultType="Trillion.Palet.DTO.CancelDTO">
  		select * from (select row_number() over(order by cancel_seq desc) line, cancel.* from cancel) where line between #{start} and #{end}
  	</select>
  	
  	<select id="getCancelTotalCount" resultType="int">
  		select count(*) from cancel
  	</select>
  	
  	<!-- Cancel Logic -->
  	
  	<select id="categoryCheck" resultType="String">
  		select category from (select category, merchant_uid from payment 
  		UNION ALL select et_category as category, et_booknumber as merchant_uid from exticket
  		UNION ALL select pro_category as category, pro_booknumber as merchant_uid from proticket) 
  		where merchant_uid = #{value}
  	</select>
  	
  	<update id="cancelExticketUpdate">
  		update exticket set et_state = 'AC' where et_booknumber = #{value}
  	</update>
  	
  	<update id="cancelGoodsUpdate">
  		update payment set state = 'AC' where merchant_uid = #{value}
  	</update>
  	
  	<update id="cancelProticketUpdate">
  		update proticket set pro_state = 'AC' where pro_booknumber = #{value}
  	</update>  	
  	
  	<delete id="cancelPaymentCheckDelete">
  		delete from cancel where booknumber = #{value}
  	</delete>
  	
  	<update id='restoreExCountAndStock'>
  		update exhibition set sales_count = sales_count - (select et_count from exticket where et_booknumber = #{value}) 
		where e_num = (select e_num from exticket where et_booknumber = #{value})
  	</update>
  	
  	<select id="checkUsedExPoint" resultType="int">
  		select et_usedpoint from exticket where et_booknumber = #{value}
  	</select>
  	
  	<update id='restoreExpoint'>
  		update member set point = point + (select et_usedpoint from exticket where et_booknumber = #{value) 
  		where email = (select et_email from exticket where et_booknumber = #{value})
  	</update>
  	
  	<update id='restoreGoodsCountAndStock'>
  		update goods set sales_count = sales_count-(select g_count from payment 
		where merchant_uid=#{value}), g_stock = g_stock + (select g_count from payment where merchant_uid=#{value})
		where g_num = (select g_num from payment where merchant_uid=#{value})
  	</update>
  	
  	<select id='checkUsedGoodsPoint' resultType='int'>
  		select usedpoint from payment where merchant_uid = #{value}
  	</select>
  	
  	<update id='restoreGoodsPoint'>
  		update member set point = point + (select usedpoint from payment where merchant_uid = #{value)
  		where email = (select email from payment where merchant_uid = #{value})
  	</update>
  	
  	<update id='restoreProCountAndStock'>
  		update program set sales_count = sales_count - (select pro_count from proticket where pro_booknumber = #{value}) 
		where p_num = (select p_num from proticket where pro_booknumber = #{value})
  	</update>
  	
  	<select id='checkUsedProPoint' resultType='int'>
  		select pro_usedpoint from proticket where pro_booknumber = #{value}
  	</select>
  	
  	<update id='restoreProPoint'>
  		update member set point = point + (select pro_usedpoint from proticket where pro_booknumber = #{value) 
  		where email = (select pro_email from proticket where pro_booknumber = #{value})
  	</update>
  	
  </mapper>